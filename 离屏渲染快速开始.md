# ç¦»å±æ¸²æŸ“ - å¿«é€Ÿå¼€å§‹

## ä¸€å¥è¯æ€»ç»“

**åœ¨ä¸å½±å“å½“å‰å±å¹•æ¸²æŸ“çš„æƒ…å†µä¸‹ï¼Œé¢å¤–æ¸²æŸ“å¹¶å¯¼å‡ºä»»æ„åˆ†è¾¨ç‡çš„å›¾ç‰‡ã€‚**

---

## æœ€ç®€å•çš„ä½¿ç”¨

åœ¨ `scene_AppVer2.cpp` ä¸­ï¼Œæ‰¾åˆ° `renderFrame` æ–¹æ³•ï¼Œæ·»åŠ ï¼š

```cpp
virtual void renderFrame(const XrPosef &pose, const glm::mat4 &project,
                        const glm::mat4 &view, int32_t eye){
    auto frameData = std::make_shared<FrameData>();
    
    if (_eng) {
        // æ­£å¸¸æ¸²æŸ“ï¼ˆæ˜¾ç¤ºåˆ°å±å¹•ï¼‰
        Rendering->project = project;
        Rendering->view = view * frameDataPtr->viewRelocMatrix;
        Rendering->Update(*_eng->appData.get(), *_eng->sceneData.get(), frameDataPtr);
        
        // â˜…â˜…â˜… æ·»åŠ è¿™å‡ è¡Œï¼šå¯¼å‡º4Kå›¾ç‰‡ â˜…â˜…â˜…
        static bool exported = false;
        if (!exported) {
            Rendering->exportOffscreenRender(
                "/storage/emulated/0/Download/render_4K.png",
                3840, 2160,  // 4Kåˆ†è¾¨ç‡
                project,
                view * frameDataPtr->viewRelocMatrix
            );
            exported = true;
        }
    }
}
```

**ç»“æœ**ï¼š
- å±å¹•ç»§ç»­æ­£å¸¸æ˜¾ç¤ºï¼ˆ1920x1080ï¼‰
- åŒæ—¶å¯¼å‡ºä¸€å¼ 4Kåˆ†è¾¨ç‡çš„å›¾ç‰‡åˆ°Downloadæ–‡ä»¶å¤¹
- **äº’ä¸å½±å“ï¼**

---

## å¸¸ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¯¼å‡ºé«˜æ¸…å›¾ç‰‡ï¼ˆ4K/8Kï¼‰

```cpp
// å¯¼å‡º4K
Rendering->exportOffscreenRender("/path/4K.png", 3840, 2160, project, view);

// å¯¼å‡º8K
Rendering->exportOffscreenRender("/path/8K.png", 7680, 4320, project, view);
```

### åœºæ™¯2ï¼šå¯¼å‡ºç¼©ç•¥å›¾

```cpp
// å¯¼å‡ºå°å›¾ï¼ˆ512x512ï¼‰
Rendering->exportOffscreenRender("/path/thumb.png", 512, 512, project, view);
```

### åœºæ™¯3ï¼šæ‰¹é‡å¯¼å‡ºå¤šä¸ªåˆ†è¾¨ç‡

```cpp
struct Res { int w, h; std::string name; };
std::vector<Res> sizes = {
    {1280, 720, "HD"},
    {1920, 1080, "FHD"},
    {3840, 2160, "4K"}
};

for (auto& r : sizes) {
    std::string path = "/storage/emulated/0/Download/" + r.name + ".png";
    Rendering->exportOffscreenRender(path, r.w, r.h, project, view);
}
```

### åœºæ™¯4ï¼šå®šæ—¶å¯¼å‡º

```cpp
// æ¯100å¸§å¯¼å‡ºä¸€æ¬¡
static int frame = 0;
if (++frame % 100 == 0) {
    auto ts = std::chrono::system_clock::now().time_since_epoch().count();
    std::string path = "/storage/emulated/0/Download/snap_" + std::to_string(ts) + ".png";
    Rendering->exportOffscreenRender(path, 2560, 1440, project, view);
}
```

---

## API è¯´æ˜

```cpp
bool exportOffscreenRender(
    const std::string& outputPath,  // è¾“å‡ºè·¯å¾„
    int targetWidth,                // ç›®æ ‡å®½åº¦
    int targetHeight,               // ç›®æ ‡é«˜åº¦
    const glm::mat4& project,       // æŠ•å½±çŸ©é˜µ
    const glm::mat4& view           // è§†å›¾çŸ©é˜µ
);
```

**å‚æ•°**ï¼š
- `outputPath`: æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ `"/storage/emulated/0/Download/image.png"`
- `targetWidth`, `targetHeight`: ä»»æ„åˆ†è¾¨ç‡ï¼ˆå¦‚ 3840x2160 è¡¨ç¤º4Kï¼‰
- `project`, `view`: ä½¿ç”¨å½“å‰æ¸²æŸ“çš„çŸ©é˜µå³å¯

**è¿”å›å€¼**ï¼š
- `true`: æˆåŠŸ
- `false`: å¤±è´¥ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰

---

## ä¸æ™®é€šå¯¼å‡ºçš„åŒºåˆ«

| ç‰¹æ€§ | `exportRenderResult()` | `exportOffscreenRender()` |
|------|------------------------|---------------------------|
| åˆ†è¾¨ç‡ | å›ºå®šï¼ˆ1920x1080ï¼‰ | ä»»æ„ |
| å½±å“å±å¹• | ä¸å½±å“ | ä¸å½±å“ |
| æ€§èƒ½å¼€é”€ | å° | ç¨å¤§ |
| ä½¿ç”¨åœºæ™¯ | å¿«é€Ÿæˆªå± | é«˜æ¸…/å¤šåˆ†è¾¨ç‡å¯¼å‡º |

---

## æ€§èƒ½æç¤º

1. **é¦–æ¬¡è°ƒç”¨ç¨æ…¢**ï¼ˆéœ€è¦åˆ›å»ºFBOï¼‰ï¼Œåç»­è°ƒç”¨ç›¸åŒåˆ†è¾¨ç‡ä¼šå¿«å¾ˆå¤š
2. **ä¸è¦æ¯å¸§éƒ½å¯¼å‡º**ï¼Œå»ºè®®é—´éš”è‡³å°‘30-100å¸§
3. **JPGæ¯”PNGå¿«**ï¼š`"image.jpg"` vs `"image.png"`
4. **åˆ†è¾¨ç‡è¶Šé«˜è¶Šæ…¢**ï¼š4Kçº¦è€—æ—¶50-100msï¼Œ8Kçº¦200-400ms

---

## éªŒè¯å¯¼å‡ºç»“æœ

```bash
# æŸ¥çœ‹å¯¼å‡ºçš„æ–‡ä»¶
adb shell ls -lh /storage/emulated/0/Download/

# æ‹‰å–åˆ°ç”µè„‘
adb pull /storage/emulated/0/Download/render_4K.png ./

# æŸ¥çœ‹æ—¥å¿—
adb logcat | grep RenderClient
```

---

## å®Œæ•´ç¤ºä¾‹

```cpp
// åœ¨scene_AppVer2.cppçš„renderFrameä¸­
virtual void renderFrame(const XrPosef &pose, const glm::mat4 &project,
                        const glm::mat4 &view, int32_t eye){
    auto frameData = std::make_shared<FrameData>();
    
    if (_eng) {
        // ============ æ­£å¸¸æ¸²æŸ“ï¼ˆä¸å—å½±å“ï¼‰ ============
        std::shared_ptr<PoseEstimationRokid> poseEstimationRokidPtr = 
            std::static_pointer_cast<PoseEstimationRokid>(_eng->getModule("PoseEstimationRokid"));
        if(poseEstimationRokidPtr != nullptr) {
            std::vector<glm::mat4> &joc = poseEstimationRokidPtr->get_joint_loc();
            Rendering->joc = joc;
        }
        
        std::shared_ptr<CollisionDetection> collisionDetectionPtr = 
            std::static_pointer_cast<CollisionDetection>(_eng->getModule("CollisionDetection"));
        if(collisionDetectionPtr != nullptr) {
            Rendering->boundingBoxArray = collisionDetectionPtr->GetBoundingBoxArray();
        }
        
        auto& frameDataPtr = _eng->frameData;
        if(frameDataPtr) {
            Rendering->project = project;
            Rendering->view = view * frameDataPtr->viewRelocMatrix;
            Rendering->Update(*_eng->appData.get(), *_eng->sceneData.get(), frameDataPtr);
        }
        
        // ============ ç¦»å±æ¸²æŸ“å¯¼å‡ºï¼ˆé¢å¤–çš„ï¼Œä¸å½±å“ä¸Šé¢ï¼‰ ============
        static int exportCounter = 0;
        exportCounter++;
        
        // æ¯300å¸§å¯¼å‡ºä¸€æ¬¡4Kå›¾ç‰‡
        if (exportCounter == 300) {
            auto timestamp = std::chrono::system_clock::now().time_since_epoch().count();
            std::string path = "/storage/emulated/0/Download/render_4K_" + 
                             std::to_string(timestamp) + ".png";
            
            bool success = Rendering->exportOffscreenRender(
                path,
                3840, 2160,  // 4Kåˆ†è¾¨ç‡
                project,
                view * frameDataPtr->viewRelocMatrix
            );
            
            if (success) {
                LOGI("âœ… 4Kå›¾ç‰‡å¯¼å‡ºæˆåŠŸ: %s", path.c_str());
            } else {
                LOGI("âŒ å¯¼å‡ºå¤±è´¥");
            }
            
            exportCounter = 0;  // é‡ç½®è®¡æ•°å™¨
        }
    }
}
```

---

## å¸¸è§é—®é¢˜

**Q: ä¼šå½±å“å½“å‰æ¸²æŸ“å—ï¼Ÿ**  
A: ä¸ä¼šï¼ä½¿ç”¨ç‹¬ç«‹çš„FBOï¼Œå®Œå…¨ä¸å½±å“å±å¹•æ˜¾ç¤ºã€‚

**Q: å¯ä»¥å¯¼å‡ºå¤šå¤§çš„åˆ†è¾¨ç‡ï¼Ÿ**  
A: å–å†³äºGPUé™åˆ¶ï¼Œä¸€èˆ¬æ”¯æŒåˆ°8Kï¼ˆ7680x4320ï¼‰ï¼Œéƒ¨åˆ†è®¾å¤‡å¯èƒ½æ›´é«˜ã€‚

**Q: æ€§èƒ½å¼€é”€å¤§å—ï¼Ÿ**  
A: ä¸­ç­‰ã€‚4Kå¯¼å‡ºçº¦50-100msï¼Œå»ºè®®ä¸è¦æ¯å¸§éƒ½å¯¼å‡ºã€‚

**Q: å¯¼å‡ºçš„å›¾ç‰‡æ˜¯é»‘è‰²çš„ï¼Ÿ**  
A: æ£€æŸ¥projectå’ŒviewçŸ©é˜µæ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿åœºæ™¯åœ¨è§†é‡å†…ã€‚

**Q: å¯ä»¥ä½¿ç”¨ä¸åŒçš„è§†è§’å—ï¼Ÿ**  
A: å¯ä»¥ï¼ä¼ å…¥ä¸åŒçš„viewçŸ©é˜µå³å¯ä»ä¸åŒè§’åº¦æ¸²æŸ“ã€‚

---

**ğŸ‰ ç°åœ¨ä½ å¯ä»¥è½»æ¾å¯¼å‡ºä»»æ„åˆ†è¾¨ç‡çš„æ¸²æŸ“ç»“æœäº†ï¼**

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒï¼š`ç¦»å±æ¸²æŸ“å¯¼å‡ºæŒ‡å—.md`
