# 驾驶舱模型方位问题修复验证指南

## 修复内容总结

### 修改的文件
- `app/src/main/cpp/AREngine/Location/src/Location.cpp`

### 核心修复
**问题：** 在有地图模式（二次开机）下，每次检测到Marker时都会用错误的 `alignTransG2M` 重新计算 `markerPoseInMap`，导致驾驶舱模型位置错误。

**修复：** 在有地图模式下，不再重新计算 `markerPoseInMap`，而是使用从文件加载的固定值。只有在无地图模式（首次建图）时才更新 `markerPoseInMap`。

### 代码变更对比

**修复前（错误代码）：**
```cpp
} else {
    // 有地图模式：
    markerPoseInMap = alignTransG2M * markerPoseInGlass;  // ❌ 每次都重新计算
    glm::mat4 worldFromMap = m_markerPose_Cockpit * glm::inverse(markerPoseInMap);
    m_worldAlignMatrix = worldFromMap * alignTransG2M;
}
```

**修复后（正确代码）：**
```cpp
} else {
    // 有地图模式：
    // 使用从文件加载的 markerPoseInMap（不要重新计算！）
    LOGI("[Location Update] 有地图模式：使用已加载的 markerPoseInMap（不重新计算）");
    glm::mat4 worldFromMap = m_markerPose_Cockpit * glm::inverse(markerPoseInMap);
    m_worldAlignMatrix = worldFromMap * alignTransG2M;
}
```

## 验证步骤

### 前置条件
1. 确保已经完成过一次**首次建图**（isLoadMap = false 模式）
2. 确保 `makerPoseInMapFile.txt` 文件已经生成并保存
   - 文件路径：`/storage/emulated/0/AppVer2Data/CameraTracking/makerPoseInMapFile.txt`

### 验证方法

#### 方法1：多次重启测试
1. **第一次启动**（二次开机模式，isLoadMap = true）
   - 在环境中任意位置开机（记为位置A）
   - 等待系统初始化和重定位完成
   - 观察驾驶舱模型的位置（记为坐标P）

2. **第二次启动**
   - 关闭应用，摘下眼镜
   - 走到环境中的另一个位置（记为位置B，与A有较大距离）
   - 再次戴上眼镜，启动应用
   - 等待系统初始化和重定位完成
   - 观察驾驶舱模型的位置

3. **验证结果**
   - ✅ **修复成功**：驾驶舱模型出现在与第一次相同的环境位置（坐标P）
   - ❌ **仍有问题**：驾驶舱模型相对于开机位置B保持固定偏移，而不是在环境的固定位置

#### 方法2：查看日志验证
使用 `adb logcat` 查看日志输出：

```bash
adb logcat | grep "Location"
```

**期望看到的日志：**

1. **Init阶段**（启动时）：
```
[Location Init] 成功从文件加载 markerPoseInMap
[Location Init] markerPoseInMap = mat4x4((...))
```

2. **Update阶段**（检测到Marker时）：
```
[Location Update] 检测到 Marker, isLoadMap=1
[Location Update] 有地图模式：使用已加载的 markerPoseInMap（不重新计算）
```

3. **每60帧输出一次**：
```
[Location Update] markerPoseInMap = mat4x4((...))
```

**如果看到这些日志，说明：**
- markerPoseInMap 在 Init 时成功加载
- 在有地图模式下检测到 Marker 时，不会重新计算 markerPoseInMap
- markerPoseInMap 的值在整个运行过程中保持不变

#### 方法3：对比修复前后的行为

| 场景 | 修复前（错误） | 修复后（正确） |
|------|----------------|----------------|
| 从位置A开机 | 驾驶舱在相对于A的固定方位 | 驾驶舱在环境中的固定位置P |
| 从位置B开机 | 驾驶舱在相对于B的固定方位（与A开机时不同） | 驾驶舱在环境中的固定位置P（与A开机时相同） |
| markerPoseInMap | 每次检测到Marker都会变化 | 保持从文件加载的固定值 |

## 可能遇到的问题

### 问题1：仍然出现位置错误
**可能原因：**
- `makerPoseInMapFile.txt` 文件损坏或数据不正确
- 首次建图时的数据质量不佳

**解决方案：**
1. 删除旧的地图文件
2. 重新进行首次建图（isLoadMap = false）
3. 确保首次建图时：
   - 环境光照充足
   - Marker 清晰可见
   - SLAM 重定位成功

### 问题2：日志显示"无法加载 markerPoseInMap"
**可能原因：**
- 文件路径错误
- 文件不存在或为空
- 文件权限问题

**解决方案：**
1. 检查文件是否存在：
```bash
adb shell ls -l /storage/emulated/0/AppVer2Data/CameraTracking/makerPoseInMapFile.txt
```

2. 查看文件内容：
```bash
adb shell cat /storage/emulated/0/AppVer2Data/CameraTracking/makerPoseInMapFile.txt
```

3. 如果文件不存在，先运行一次无地图模式（isLoadMap = false）生成该文件

### 问题3：SLAM 重定位失败
**症状：** 即使修复了代码，驾驶舱位置仍然不稳定

**可能原因：**
- 服务器重定位模块未正常工作
- `alignTransform` 未正确更新

**解决方案：**
1. 检查服务器连接状态
2. 查看 CameraTracking 相关日志：
```bash
adb logcat | grep "CameraTracking"
```

3. 确认 `alignTransform` 是否从服务器正确返回

## 技术说明

### 坐标系统关系
```
虚拟世界坐标系 (World)
    ↑
    | T_World_Marker (固定，定义驾驶舱在虚拟世界中的位置)
    |
Marker 坐标系
    ↑
    | T_Marker_Map^(-1) (固定，从 markerPoseInMap 计算)
    |
地图坐标系 (Map)
    ↑
    | T_Map_Glass (实时变化，由SLAM重定位提供)
    |
眼镜坐标系 (Glass)
```

### 关键变量说明
- `m_markerPose_Cockpit`：驾驶舱在 Marker 坐标系下的目标位姿（固定）
- `markerPoseInMap`：Marker 在地图坐标系下的位姿（**应该固定不变**）
- `alignTransG2M`：眼镜坐标系到地图坐标系的变换（实时变化）
- `m_worldAlignMatrix`：最终的世界对齐矩阵

### 为什么修复有效
1. **首次建图时**（isLoadMap = false）：
   - 检测到 Marker 时，用当前的 `alignTransG2M` 计算 `markerPoseInMap`
   - 将 `markerPoseInMap` 保存到文件
   - 此时的 `markerPoseInMap` 是准确的

2. **二次开机时**（isLoadMap = true）：
   - 从文件加载之前保存的 `markerPoseInMap`
   - **不再重新计算**，避免使用错误的 `alignTransG2M`
   - 使用固定的 `markerPoseInMap` 和实时的 `alignTransG2M` 计算最终位姿

## 后续优化建议

1. **添加 markerPoseInMap 有效性检查**
   - 检测 markerPoseInMap 是否为单位矩阵
   - 如果是单位矩阵，可能表示数据未正确保存

2. **添加重定位完成标志**
   - 在重定位完成前，优先使用 Marker 提供的对齐
   - 重定位完成后，融合 SLAM 和 Marker 的定位结果

3. **添加位姿一致性检查**
   - 对比多次 Marker 检测的结果
   - 如果差异过大，可能表示重定位失败

4. **优化首次建图流程**
   - 引导用户在最佳条件下进行首次建图
   - 提供反馈信息（如 Marker 检测质量、SLAM 状态等）
