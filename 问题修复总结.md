# é©¾é©¶èˆ±æ¨¡å‹æ–¹ä½é—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜ç°è±¡
æ¯æ¬¡äºŒæ¬¡å¼€æœºåï¼Œé©¾é©¶èˆ±æ¨¡å‹æ€»æ˜¯å’Œå¼€æœºä½ç½®ä¿æŒå›ºå®šæ–¹ä½ï¼Œè€Œä¸æ˜¯æ ¹æ®é‡å®šä½ç­–ç•¥åœ¨ç¯å¢ƒçš„å›ºå®šä½ç½®ã€‚

## æ ¹æœ¬åŸå› 
åœ¨ `Location.cpp` çš„ Update æ–¹æ³•ä¸­ï¼Œå½“ç³»ç»Ÿå¤„äº**æœ‰åœ°å›¾æ¨¡å¼**ï¼ˆisLoadMap = trueï¼‰ä¸”æ£€æµ‹åˆ° Marker æ—¶ï¼Œä»£ç ä¼š**é”™è¯¯åœ°é‡æ–°è®¡ç®—** `markerPoseInMap`ï¼š

```cpp
// é”™è¯¯ä»£ç ï¼ˆç¬¬188è¡Œï¼‰
markerPoseInMap = alignTransG2M * markerPoseInGlass;
```

### é—®é¢˜åˆ†æ
1. **æ—¶åºé—®é¢˜**ï¼š
   - äºŒæ¬¡å¼€æœºæ—¶ï¼ŒSLAM é‡å®šä½éœ€è¦æ—¶é—´ï¼ˆå¯èƒ½å‡ ç§’ï¼‰
   - åœ¨é‡å®šä½å®Œæˆå‰ï¼Œ`alignTransform` ä»ç„¶æ˜¯å•ä½çŸ©é˜µ
   - æ­¤æ—¶ `alignTransG2M` çš„å€¼æ˜¯é”™è¯¯çš„ï¼ˆ= `alignTransformLast.inv()`ï¼‰

2. **æ•°æ®æ±¡æŸ“**ï¼š
   - å¦‚æœåœ¨é‡å®šä½å®Œæˆå‰å°±æ£€æµ‹åˆ° Marker
   - ä¼šç”¨é”™è¯¯çš„ `alignTransG2M` é‡æ–°è®¡ç®— `markerPoseInMap`
   - å¯¼è‡´ `markerPoseInMap` ä»æ­£ç¡®å€¼è¢«è¦†ç›–ä¸ºé”™è¯¯å€¼
   - æœ€ç»ˆå¯¼è‡´é©¾é©¶èˆ±æ¨¡å‹ä½ç½®å®Œå…¨é”™è¯¯

3. **é€»è¾‘é”™è¯¯**ï¼š
   - åœ¨æœ‰åœ°å›¾æ¨¡å¼ä¸‹ï¼Œ`markerPoseInMap` åº”è¯¥æ˜¯**å›ºå®šå€¼**ï¼ˆä»£è¡¨ Marker åœ¨åœ°å›¾ä¸­çš„å›ºå®šä½ç½®ï¼‰
   - ä½†åŸä»£ç æ¯æ¬¡æ£€æµ‹åˆ° Marker éƒ½ä¼šé‡æ–°è®¡ç®—å®ƒ
   - è¿åäº†"ç¯å¢ƒä¸­å›ºå®šä½ç½®"çš„è®¾è®¡ç›®æ ‡

## ä¿®å¤æ–¹æ¡ˆ
ä¿®æ”¹ `app/src/main/cpp/AREngine/Location/src/Location.cpp` æ–‡ä»¶ï¼š

### æ ¸å¿ƒä¿®æ”¹
**åœ¨æœ‰åœ°å›¾æ¨¡å¼ä¸‹ï¼Œä¸å†é‡æ–°è®¡ç®— `markerPoseInMap`ï¼Œè€Œæ˜¯ä½¿ç”¨ä»æ–‡ä»¶åŠ è½½çš„å›ºå®šå€¼ã€‚**

### å…·ä½“æ”¹åŠ¨

#### 1. ä¿®æ”¹ Update æ–¹æ³•ï¼ˆç¬¬180-209è¡Œï¼‰
```cpp
// ä¿®å¤å‰
} else {
    markerPoseInMap = alignTransG2M * markerPoseInGlass;  // âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
    glm::mat4 worldFromMap = m_markerPose_Cockpit * glm::inverse(markerPoseInMap);
    m_worldAlignMatrix = worldFromMap * alignTransG2M;
}

// ä¿®å¤å
} else {
    // æœ‰åœ°å›¾æ¨¡å¼ï¼šä½¿ç”¨ä»æ–‡ä»¶åŠ è½½çš„ markerPoseInMapï¼ˆä¸è¦é‡æ–°è®¡ç®—ï¼ï¼‰
    LOGI("[Location Update] æœ‰åœ°å›¾æ¨¡å¼ï¼šä½¿ç”¨å·²åŠ è½½çš„ markerPoseInMapï¼ˆä¸é‡æ–°è®¡ç®—ï¼‰");
    
    // âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨åŠ è½½çš„å›ºå®šå€¼
    glm::mat4 worldFromMap = m_markerPose_Cockpit * glm::inverse(markerPoseInMap);
    m_worldAlignMatrix = worldFromMap * alignTransG2M;
}
```

#### 2. åœ¨æ— åœ°å›¾æ¨¡å¼ä¸‹æ›´æ–° markerPoseInMapï¼ˆç¬¬187-195è¡Œï¼‰
```cpp
if (!appData.isLoadMap) {
    // æ— åœ°å›¾æ¨¡å¼ï¼šç›´æ¥å¯¹é½åˆ° Marker
    m_worldAlignMatrix = m_markerPose_Cockpit * glm::inverse(markerPoseInGlass);
    
    // âœ… åŒæ—¶æ›´æ–° markerPoseInMapï¼Œç”¨äºåç»­ä¿å­˜
    markerPoseInMap = alignTransG2M * markerPoseInGlass;
    LOGI("[Location Update] æ— åœ°å›¾æ¨¡å¼ï¼šæ›´æ–° markerPoseInMap");
}
```

#### 3. æ·»åŠ è°ƒè¯•æ—¥å¿—
- Init æ—¶è®°å½• markerPoseInMap çš„åŠ è½½çŠ¶æ€
- Update æ—¶è®°å½•æ˜¯å¦æ£€æµ‹åˆ° Marker å’Œå½“å‰æ¨¡å¼
- æ¯ 60 å¸§è¾“å‡ºä¸€æ¬¡ markerPoseInMap çš„å€¼ï¼ˆé¿å…åˆ·å±ï¼‰

## ä¿®å¤æ•ˆæœ
ä¿®å¤åï¼Œç³»ç»Ÿè¡Œä¸ºåº”è¯¥æ˜¯ï¼š

| åœºæ™¯ | è¡Œä¸º |
|------|------|
| **é¦–æ¬¡å»ºå›¾**ï¼ˆisLoadMap=falseï¼‰ | æ£€æµ‹åˆ° Marker æ—¶è®¡ç®—å¹¶ä¿å­˜ `markerPoseInMap` |
| **äºŒæ¬¡å¼€æœº**ï¼ˆisLoadMap=trueï¼‰ | ä»æ–‡ä»¶åŠ è½½ `markerPoseInMap`ï¼Œä¸å†é‡æ–°è®¡ç®— |
| **ä»ä½ç½®Aå¼€æœº** | é©¾é©¶èˆ±å‡ºç°åœ¨ç¯å¢ƒä¸­çš„å›ºå®šä½ç½®P |
| **ä»ä½ç½®Bå¼€æœº** | é©¾é©¶èˆ±å‡ºç°åœ¨ç¯å¢ƒä¸­çš„å›ºå®šä½ç½®Pï¼ˆä¸ä»Aå¼€æœºæ—¶ç›¸åŒï¼‰ |

## éªŒè¯æ–¹æ³•

### å¿«é€ŸéªŒè¯
1. ä»ä¸åŒä½ç½®å¤šæ¬¡å¯åŠ¨åº”ç”¨ï¼ˆäºŒæ¬¡å¼€æœºæ¨¡å¼ï¼‰
2. è§‚å¯Ÿé©¾é©¶èˆ±æ¨¡å‹æ˜¯å¦å§‹ç»ˆå‡ºç°åœ¨ç¯å¢ƒçš„**ç›¸åŒä½ç½®**
3. âœ… æˆåŠŸï¼šæ— è®ºä»å“ªé‡Œå¼€æœºï¼Œé©¾é©¶èˆ±ä½ç½®ä¸€è‡´
4. âŒ å¤±è´¥ï¼šé©¾é©¶èˆ±ä½ç½®éšå¼€æœºä½ç½®å˜åŒ–

### æ—¥å¿—éªŒè¯
ä½¿ç”¨ `adb logcat | grep "Location"` æŸ¥çœ‹æ—¥å¿—ï¼š

**å¯åŠ¨æ—¶åº”è¯¥çœ‹åˆ°ï¼š**
```
[Location Init] æˆåŠŸä»æ–‡ä»¶åŠ è½½ markerPoseInMap
[Location Init] markerPoseInMap = mat4x4(...)
```

**æ£€æµ‹åˆ° Marker æ—¶åº”è¯¥çœ‹åˆ°ï¼š**
```
[Location Update] æ£€æµ‹åˆ° Marker, isLoadMap=1
[Location Update] æœ‰åœ°å›¾æ¨¡å¼ï¼šä½¿ç”¨å·²åŠ è½½çš„ markerPoseInMapï¼ˆä¸é‡æ–°è®¡ç®—ï¼‰
```

## ç›¸å…³æ–‡ä»¶
- âœ… å·²ä¿®æ”¹ï¼š`app/src/main/cpp/AREngine/Location/src/Location.cpp`
- âœ… å·²ä¿®æ”¹ï¼š`app/src/main/cpp/AREngine/CameraTracking/src/CameraTracking.cpp`ï¼ˆé¢å¤–ä¿®å¤ï¼‰
- ğŸ“„ åˆ†ææŠ¥å‘Šï¼š`é—®é¢˜åˆ†ææŠ¥å‘Š.md`
- ğŸ“„ éªŒè¯æŒ‡å—ï¼š`ä¿®å¤éªŒè¯æŒ‡å—.md`

## æŠ€æœ¯è¦ç‚¹

### åæ ‡ç³»å˜æ¢
```
T_World_Glass = T_World_Marker Ã— T_Marker_Map^(-1) Ã— T_Map_Glass
                    â†‘               â†‘                   â†‘
              (å›ºå®šï¼Œå®šä¹‰)    (å›ºå®šï¼Œä»æ–‡ä»¶åŠ è½½)  (å®æ—¶ï¼ŒSLAMæä¾›)
```

### å…³é”®å˜é‡
- `m_markerPose_Cockpit`ï¼šé©¾é©¶èˆ±ç›¸å¯¹äº Marker çš„ç›®æ ‡ä½å§¿ï¼ˆå›ºå®šï¼‰
- **`markerPoseInMap`**ï¼šMarker åœ¨åœ°å›¾ä¸­çš„ä½å§¿ï¼ˆ**åº”è¯¥å›ºå®šä¸å˜**ï¼‰â­
- `alignTransG2M`ï¼šçœ¼é•œåˆ°åœ°å›¾çš„å˜æ¢ï¼ˆå®æ—¶å˜åŒ–ï¼Œç”±SLAMæä¾›ï¼‰
- `m_worldAlignMatrix`ï¼šæœ€ç»ˆçš„ä¸–ç•Œå¯¹é½çŸ©é˜µï¼ˆè¾“å‡ºï¼‰

### ä¸ºä»€ä¹ˆä¿®å¤æœ‰æ•ˆ
- **é¦–æ¬¡å»ºå›¾æ—¶**ï¼šç”¨æ­£ç¡®çš„ `alignTransG2M` è®¡ç®—å¹¶ä¿å­˜ `markerPoseInMap`
- **äºŒæ¬¡å¼€æœºæ—¶**ï¼šç›´æ¥ä½¿ç”¨ä¿å­˜çš„ `markerPoseInMap`ï¼Œé¿å…ä½¿ç”¨é”™è¯¯çš„ `alignTransG2M`
- **ç»“æœ**ï¼šé©¾é©¶èˆ±å§‹ç»ˆåœ¨ç¯å¢ƒä¸­çš„å›ºå®šä½ç½®ï¼Œä¸å—å¼€æœºä½ç½®å½±å“

## é¢å¤–ä¿®å¤ï¼šä¿å­˜ alignTransform

åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†å¦ä¸€ä¸ªç›¸å…³é—®é¢˜å¹¶ä¸€å¹¶ä¿®å¤ï¼š

### é—®é¢˜
`CameraTracking::ShutDown()` æ–¹æ³•ä¸­æ²¡æœ‰ä¿å­˜å½“å‰çš„ `alignTransform`ï¼Œå¯¼è‡´ä¸‹æ¬¡å¯åŠ¨æ—¶ä»ç„¶ä½¿ç”¨æ—§çš„ `alignTransformLast`ã€‚

### ä¿®å¤
åœ¨ `CameraTracking.cpp` çš„ ShutDown æ–¹æ³•ä¸­æ·»åŠ ä¿å­˜é€»è¾‘ï¼š

```cpp
if (appData.isLoadMap && !alignTransform.empty()) {
    std::ofstream out(alignTransformLastFile);
    if (out.is_open()) {
        for (int i = 0; i < 4; i++) {
            for (int j = 0; j < 4; j++) {
                out << alignTransform.at<float>(i, j) << " ";
            }
            out << "\n";
        }
        out.close();
    }
}
```

### å½±å“
è¿™ä¸ªä¿®å¤ç¡®ä¿æ¯æ¬¡å…³é—­åº”ç”¨æ—¶ï¼Œæœ€æ–°çš„é‡å®šä½ç»“æœä¼šè¢«ä¿å­˜ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶å¯ä»¥ä½œä¸ºåˆå§‹å¯¹é½ä½¿ç”¨ã€‚

## æ³¨æ„äº‹é¡¹
1. ç¡®ä¿é¦–æ¬¡å»ºå›¾æ—¶æ•°æ®è´¨é‡è‰¯å¥½ï¼ˆå…‰ç…§å……è¶³ã€Marker æ¸…æ™°å¯è§ï¼‰
2. å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼Œå¯èƒ½éœ€è¦é‡æ–°è¿›è¡Œé¦–æ¬¡å»ºå›¾
3. ç¡®ä¿ SLAM æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼ˆscene_CLDE.cpp ç¬¬113è¡Œï¼‰
4. ç›¸å…³æ–‡ä»¶è·¯å¾„ï¼š
   - `markerPoseInMap`: `/storage/emulated/0/AppVer2Data/CameraTracking/makerPoseInMapFile.txt`
   - `alignTransform`: `/storage/emulated/0/AppVer2Data/CameraTracking/anchorFile.txt`

## åç»­å»ºè®®
1. æ·»åŠ  `markerPoseInMap` æœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆé¿å…ä½¿ç”¨å•ä½çŸ©é˜µï¼‰
2. æ·»åŠ é‡å®šä½å®Œæˆæ ‡å¿—ï¼Œä¼˜åŒ–å¯åŠ¨é˜¶æ®µçš„å®šä½ç­–ç•¥
3. è€ƒè™‘ Marker å’Œ SLAM çš„èåˆå®šä½ï¼Œæé«˜é²æ£’æ€§
